{% extends "base.html" %}

{% block title %}Î¤Î± Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÎ¬ Î¼Î¿Ï…{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto mt-8 px-4 sm:px-6 lg:px-8">

    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Î›Î¯ÏƒÏ„Î± Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÏÎ½</h2>
        <a href="{{ url_for('main.new_invoice') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow flex items-center gap-2 text-sm sm:text-base">
            <span>+</span> <span class="hidden sm:inline">ÎÎ­Î¿ Î¤Î¹Î¼Î¿Î»ÏŒÎ³Î¹Î¿</span><span class="sm:hidden">ÎÎ­Î¿</span>
        </a>
    </div>

    <div class="grid grid-cols-1 gap-4 md:hidden">
        {% for inv in invoices %}
        <div class="bg-white p-4 rounded-lg shadow border border-gray-200">

            <div class="flex justify-between items-start mb-3">
                <div>
                    <span class="text-lg font-bold text-gray-800">#{{ inv.number }}</span>
                    <span class="text-xs text-gray-500 block">{{ inv.issue_date.strftime('%d/%m/%Y') }}</span>
                </div>
                <div>
                    {% if inv.mydata_mark %}
                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Sent</span>
                    {% else %}
                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Draft</span>
                    {% endif %}
                </div>
            </div>

            <div class="mb-4">
                <div class="text-sm text-gray-600 mb-1 truncate">{{ inv.customer_name }}</div>
                <div class="text-xl font-bold text-blue-600">{{ "%.2f"|format(inv.total_value) }} â‚¬</div>
            </div>

            <div class="grid grid-cols-3 gap-2 border-t pt-3">
                <a href="{{ url_for('main.print_invoice', invoice_id=inv.id) }}" target="_blank" class="flex flex-col items-center justify-center text-blue-600 hover:bg-blue-50 p-1 rounded">
                    <span class="text-xl">ğŸ“„</span>
                    <span class="text-[10px] font-bold uppercase">PDF</span>
                </a>

                {% if not inv.is_paid %}
                <button onclick="payWithPos({{ inv.id }}, {{ inv.total_value }}, this)" class="flex flex-col items-center justify-center text-indigo-600 hover:bg-indigo-50 p-1 rounded">
                    <span class="text-xl">ğŸ’³</span>
                    <span class="text-[10px] font-bold uppercase">POS Pay</span>
                </button>
                {% else %}
                <div class="flex flex-col items-center justify-center text-green-600 p-1">
                    <span class="text-xl">âœ…</span>
                    <span class="text-[10px] font-bold uppercase">Paid</span>
                </div>
                {% endif %}

                {% if not inv.mydata_mark %}
                <form action="{{ url_for('main.send_to_mydata', invoice_id=inv.id) }}" method="POST" onsubmit="return confirm('Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ myDATA;');" class="w-full h-full">
                    <button type="submit" class="flex flex-col items-center justify-center w-full h-full text-green-600 hover:bg-green-50 p-1 rounded">
                        <span class="text-xl">â˜ï¸</span>
                        <span class="text-[10px] font-bold uppercase">myDATA</span>
                    </button>
                </form>
                {% else %}
                <div class="flex flex-col items-center justify-center text-gray-400 p-1" title="MARK: {{ inv.mydata_mark }}">
                    <span class="text-xl">ğŸ”’</span>
                    <span class="text-[10px] font-bold uppercase">Sent</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="text-center text-gray-500 py-10 bg-white rounded shadow">
            Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï€Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÎ¬.
        </div>
        {% endfor %}
    </div>

    <div class="hidden md:block bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full leading-normal">
            <thead>
                <tr>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Î—Î¼/Î½Î¹Î±</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Î ÎµÎ»Î¬Ï„Î·Ï‚</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">ÎšÎ±Î¸Î±ÏÎ® Î‘Î¾Î¯Î±</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Î¦Î Î‘</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Î£ÏÎ½Î¿Î»Î¿</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
                </tr>
            </thead>
           <tbody>
                {% for inv in invoices %}
                <tr class="hover:bg-gray-50 border-b border-gray-200">
                    <td class="px-5 py-4 text-sm text-gray-700">{{ inv.issue_date.strftime('%d/%m/%Y') }}</td>
                    <td class="px-5 py-4 text-sm font-bold text-gray-800">#{{ inv.number }} <span class="text-xs font-normal text-gray-500">({{ inv.series }})</span></td>
                    <td class="px-5 py-4 text-sm text-gray-700 truncate max-w-xs" title="{{ inv.customer_name }}">{{ inv.customer_name }}</td>
                    <td class="px-5 py-4 text-sm text-right text-gray-700">{{ "%.2f"|format(inv.net_value) }} â‚¬</td>
                    <td class="px-5 py-4 text-sm text-right text-gray-500">{{ "%.2f"|format(inv.vat_value) }} â‚¬</td>
                    <td class="px-5 py-4 text-sm text-right font-bold text-blue-600">{{ "%.2f"|format(inv.total_value) }} â‚¬</td>
                    <td class="px-5 py-4 text-center">
                        {% if inv.mydata_mark %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Sent</span>
                        {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Draft</span>
                        {% endif %}
                    </td>
                    <td class="px-5 py-4 text-right text-sm">
                        <div class="flex flex-col items-end gap-3">
                            <a href="{{ url_for('main.print_invoice', invoice_id=inv.id) }}" target="_blank" class="text-blue-600 hover:text-blue-900 font-bold text-xs uppercase cursor-pointer">ğŸ“„ Î ÏÎ¿Î²Î¿Î»Î® PDF</a>

                            {% if not inv.is_paid %}

                                {# --- Î Î•Î¡Î™Î Î¤Î©Î£Î— 7: POS (Î•Î½ÎµÏÎ³ÏŒ ÎšÎ¿Ï…Î¼Ï€Î¯) --- #}
                                {% if inv.payment_method|string == '7' %}
                                    <button onclick="payWithPos({{ inv.id }}, {{ inv.total_value }}, this)" class="flex items-center gap-1 text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded text-xs font-bold shadow transition duration-150">
                                        <span>ğŸ’³</span> POS Pay
                                    </button>

                                {# --- Î¥Î ÎŸÎ›ÎŸÎ™Î Î•Î£ Î Î•Î¡Î™Î Î¤Î©Î£Î•Î™Î£ (Î•Î½Î·Î¼ÎµÏÏ‰Ï„Î¹ÎºÎ¬ Î¤Î±Î¼Ï€ÎµÎ»Î¬ÎºÎ¹Î±) --- #}
                                {% else %}
                                    <span class="text-xs text-gray-500 font-medium border border-gray-200 bg-gray-50 px-2 py-1 rounded cursor-default whitespace-nowrap">
                                        {% if inv.payment_method|string == '3' %}
                                            ğŸ’µ ÎœÎµÏ„ÏÎ·Ï„Î¬
                                        {% elif inv.payment_method|string == '5' %}
                                            â³ Î•Ï€Î¯ Î Î¹ÏƒÏ„ÏÏƒÎµÎ¹
                                        {% elif inv.payment_method|string == '1' %}
                                            ğŸ¦ Î¤ÏÎ¬Ï€ÎµÎ¶Î± (GR)
                                        {% elif inv.payment_method|string == '2' %}
                                            ğŸŒ Î¤ÏÎ¬Ï€ÎµÎ¶Î± (Î•Î¾Ï‰Ï„.)
                                        {% elif inv.payment_method|string == '4' %}
                                            ğŸ–‹ï¸ Î•Ï€Î¹Ï„Î±Î³Î®
                                        {% elif inv.payment_method|string == '6' %}
                                            ğŸ’» Web Banking
                                        {% elif inv.payment_method|string == '8' %}
                                            ğŸ“± IRIS Payment
                                        {% else %}
                                            Î†Î»Î»Î¿Ï‚ Î¤ÏÏŒÏ€Î¿Ï‚
                                        {% endif %}
                                    </span>
                                {% endif %}

                            {% else %}
                                {# --- Î‘Î Î•Î§Î•Î™ Î Î›Î—Î¡Î©Î˜Î•Î™ --- #}
                                <div class="flex items-center text-green-600 text-xs font-bold" title="Transaction ID: {{ inv.transaction_id }}">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Î Î»Î·ÏÏÎ¸Î·ÎºÎµ
                                </div>
                            {% endif %}

                            {% if not inv.mydata_mark %}
                                <form action="{{ url_for('main.send_to_mydata', invoice_id=inv.id) }}" method="POST" onsubmit="return confirm('Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î·Î½ Î‘Î‘Î”Î•;');">
                                    <button type="submit" class="flex items-center gap-1 text-white bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-xs font-bold shadow transition duration-150"><span>â˜ï¸</span> myDATA</button>
                                </form>
                            {% else %}
                                <div class="text-right mt-1">
                                    <div class="text-[10px] text-gray-500 font-mono bg-gray-50 px-2 py-1 rounded border border-gray-200" title="UID: {{ inv.mydata_uid }}">MARK: {{ inv.mydata_mark }}</div>
                                </div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="8" class="px-5 py-10 text-center text-gray-500">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï€Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÎ¬.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎ— Î‘Î›Î›Î‘Î“Î—: Î— ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î´Î­Ï‡ÎµÏ„Î±Î¹ Ï„ÏÏÎ± ÎºÎ±Î¹ Ï„Î¿ btnElement (Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯)
    function payWithPos(invoiceId, amount, btnElement) {

        // 1. Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·
        if (!confirm(`ÎÎ± ÏƒÏ„Î±Î»ÎµÎ¯ ÎµÎ½Ï„Î¿Î»Î® ÏƒÏ„Î¿ Ï„ÎµÏÎ¼Î±Ï„Î¹ÎºÏŒ Î³Î¹Î± Ï‡ÏÎ­Ï‰ÏƒÎ· ${amount}â‚¬;`)) {
            return;
        }

        // 2. ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î¿ Î±ÏÏ‡Î¹ÎºÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿
        const originalText = btnElement.innerText;

        // 3. Î‘Î»Î»Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿ Î£Î¥Î“ÎšÎ•ÎšÎ¡Î™ÎœÎ•ÎÎŸ ÎºÎ¿Ï…Î¼Ï€Î¯ Ï€Î¿Ï… Ï€Î±Ï„Î®Î¸Î·ÎºÎµ
        btnElement.innerText = "â³ Î‘Î½Î±Î¼Î¿Î½Î®...";
        btnElement.disabled = true;
        btnElement.classList.add('opacity-50', 'cursor-not-allowed'); // Î›Î¯Î³Î¿ style Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ Î±Î½ÎµÎ½ÎµÏÎ³ÏŒ

        console.log("ğŸš€ Î£Ï„Î­Î»Î½Ï‰ ÎµÎ½Ï„Î¿Î»Î® ÏƒÏ„Î¿ backend...");

        // 4. ÎšÎ»Î®ÏƒÎ· ÏƒÏ„Î¿Î½ Server
        fetch(`/invoices/${invoiceId}/pay-pos`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log("Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· Server:", data);

            if (data.success) {
                alert("âœ… " + data.message);
                location.reload(); // Î‘Î½Î±Î½Î­Ï‰ÏƒÎ· ÏƒÎµÎ»Î¯Î´Î±Ï‚ Î³Î¹Î± Î½Î± Ï†Î±Î½ÎµÎ¯ Î· Ï€Î»Î·ÏÏ‰Î¼Î®
            } else {
                alert("âŒ " + data.message);
                // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï ÏƒÎµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Î»Î¬Î¸Î¿Ï…Ï‚
                btnElement.innerText = originalText;
                btnElement.disabled = false;
                btnElement.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Î£Ï†Î¬Î»Î¼Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚ Î¼Îµ Ï„Î¿Î½ server.");
            // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï
            btnElement.innerText = originalText;
            btnElement.disabled = false;
            btnElement.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }
</script>

{% endblock %}