{% extends "base.html" %}

{% block title %}ÎÎ­Î¿ Î¤Î¹Î¼Î¿Î»ÏŒÎ³Î¹Î¿ / Î‘Ï€ÏŒÎ´ÎµÎ¹Î¾Î·{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg mt-6 border border-gray-200">

    <div class="flex justify-between items-center mb-8 border-b pb-4">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">ÎˆÎºÎ´Î¿ÏƒÎ· Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÎ¿Ï</h2>
            <p class="text-sm text-gray-500">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î½Î­Î¿Ï… Î¤Î¹Î¼Î¿Î»Î¿Î³Î¯Î¿Ï… (1.1) Î® Î‘Ï€ÏŒÎ´ÎµÎ¹Î¾Î·Ï‚ (11.1)</p>
        </div>
        <div class="text-right">
            <span class="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-bold shadow-sm">Î£ÎµÎ¹ÏÎ¬ Î‘</span>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 bg-gray-50 p-6 rounded-lg border border-gray-100">

        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
            <select id="customerSelect" class="w-full border border-gray-300 p-2.5 rounded shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                <option value="">-- Î•Ï€Î¹Î»Î¿Î³Î® Î ÎµÎ»Î¬Ï„Î· --</option>

                <option value="retail" class="font-bold text-blue-700 bg-blue-50 py-2">
                    ğŸ›’ Î Î•Î›Î‘Î¤Î—Î£ Î›Î™Î‘ÎÎ™ÎšÎ—Î£ (Î‘Ï€ÏŒÎ´ÎµÎ¹Î¾Î·)
                </option>
                <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>

                {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.afm or '---' }})</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎˆÎºÎ´Î¿ÏƒÎ·Ï‚</label>
            <input type="date" id="invoiceDate" class="w-full border border-gray-300 p-2.5 rounded shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚</label>
            <select id="paymentMethod" class="w-full border border-gray-300 p-2.5 rounded shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                {% for pm in payment_methods %}
                    <option value="{{ pm.code }}" {% if pm.code == '3' %}selected{% endif %}>
                        {{ pm.description }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full mb-6 text-left border-collapse">
            <thead>
                <tr class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wider border-b border-gray-200">
                    <th class="p-3 w-5/12 font-bold">Î¥Ï€Î·ÏÎµÏƒÎ¯Î± / Î ÏÎ¿ÏŠÏŒÎ½</th>
                    <th class="p-3 w-2/12 font-bold text-center">Î Î¿ÏƒÏŒÏ„Î·Ï„Î±</th>
                    <th class="p-3 w-2/12 font-bold text-right">Î¤Î¹Î¼Î® ÎœÎ¿Î½. (â‚¬)</th>
                    <th class="p-3 w-1/12 font-bold text-center">Î¦Î Î‘ %</th>
                    <th class="p-3 w-2/12 font-bold text-right">Î£ÏÎ½Î¿Î»Î¿ (â‚¬)</th>
                    <th class="p-3 w-10"></th>
                </tr>
            </thead>
            <tbody id="invoiceItems" class="text-sm text-gray-700">
                </tbody>
        </table>
    </div>

    <button onclick="addRow()" class="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-bold text-sm mb-8 transition hover:bg-blue-50 px-3 py-2 rounded">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
        </svg>
        Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î“ÏÎ±Î¼Î¼Î®Ï‚
    </button>

    <div class="flex flex-col md:flex-row justify-end border-t border-gray-200 pt-6">
        <div class="w-full md:w-1/3 space-y-3">
            <div class="flex justify-between text-gray-600">
                <span>ÎšÎ±Î¸Î±ÏÎ® Î‘Î¾Î¯Î±:</span>
                <span id="displayNet" class="font-medium">0.00 â‚¬</span>
            </div>
            <div class="flex justify-between text-gray-600">
                <span>Î¦Î Î‘:</span>
                <span id="displayVat" class="font-medium">0.00 â‚¬</span>
            </div>

            <div class="border-t border-gray-200 my-2"></div>

            <div class="flex justify-between text-xl font-bold text-gray-900 items-center">
                <span>Î¤ÎµÎ»Î¹ÎºÏŒ Î Î»Î·ÏÏ‰Ï„Î­Î¿:</span>
                <span id="displayTotal" class="text-blue-700">0.00 â‚¬</span>
            </div>

            <button onclick="saveInvoice()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow-lg mt-6 transition transform active:scale-95 flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Î•ÎšÎ”ÎŸÎ£Î— Î Î‘Î¡Î‘Î£Î¤Î‘Î¤Î™ÎšÎŸÎ¥
            </button>
        </div>
    </div>
</div>

<script>
    // 1. ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î±Ï€ÏŒ Python (Jinja) ÏƒÎµ JavaScript
    const availableProducts = [
        {% for p in products %}
        {
            id: {{ p.id }},
            title: "{{ p.title }}",
            price: {{ p.default_price }},
            vat: {{ p.vat_percent }},
            vat_cat: {{ p.vat_category }}
        },
        {% endfor %}
    ];

    // ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏƒÎ·Î¼ÎµÏÎ¹Î½Î®Ï‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ ÏƒÏ„Î¿ Ï€ÎµÎ´Î¯Î¿
    document.getElementById('invoiceDate').valueAsDate = new Date();

    // 2. Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚ Î“ÏÎ±Î¼Î¼Î®Ï‚
    function addRow() {
        const tbody = document.getElementById('invoiceItems');
        const tr = document.createElement('tr');
        tr.className = "border-b border-gray-100 hover:bg-gray-50 transition";

        // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÏ€Î¹Î»Î¿Î³ÏÎ½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
        let options = `<option value="">-- Î•Ï€Î¹Î»Î¿Î³Î® --</option>`;
        availableProducts.forEach(p => {
            options += `<option value="${p.id}">${p.title}</option>`;
        });

        tr.innerHTML = `
            <td class="p-3 align-top">
                <select class="product-select w-full border border-gray-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500" onchange="productChanged(this)">${options}</select>
                <input type="text" class="product-title hidden" value="">
            </td>
            <td class="p-3 align-top">
                <input type="number" class="qty-input w-full border border-gray-300 rounded p-2 text-center text-sm" value="1" min="0.01" step="0.01" oninput="calcTotals()">
            </td>
            <td class="p-3 align-top">
                <input type="number" class="price-input w-full border border-gray-300 rounded p-2 text-right text-sm" value="0.00" min="0" step="0.01" oninput="calcTotals()">
            </td>
            <td class="p-3 align-top">
                <select class="vat-input w-full border border-gray-300 rounded p-2 text-center text-sm bg-gray-50" onchange="calcTotals()">
                    <option value="24" data-cat="1">24%</option>
                    <option value="13" data-cat="2">13%</option>
                    <option value="6" data-cat="3">6%</option>
                    <option value="0" data-cat="7">0%</option>
                </select>
            </td>
            <td class="p-3 align-top text-right font-bold text-gray-700 row-total">
                0.00 â‚¬
            </td>
            <td class="p-3 align-top text-center">
                <button onclick="removeRow(this)" class="text-red-400 hover:text-red-600 transition p-1 rounded hover:bg-red-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    }

    // 3. ÎŒÏ„Î±Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï„Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ (Auto-fill)
    function productChanged(selectElement) {
        const row = selectElement.closest('tr');
        const productId = selectElement.value;
        const product = availableProducts.find(p => p.id == productId);

        if (product) {
            row.querySelector('.price-input').value = product.price.toFixed(2);
            const vatSelect = row.querySelector('.vat-input');
            vatSelect.value = product.vat;
            row.querySelector('.product-title').value = product.title;
        } else {
            row.querySelector('.price-input').value = "0.00";
            row.querySelector('.product-title').value = "";
        }
        calcTotals();
    }

    // 4. Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Î“ÏÎ±Î¼Î¼Î®Ï‚
    function removeRow(btn) {
        const row = btn.closest('tr');
        row.remove();
        calcTotals();
    }

    // 5. Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î£Ï…Î½ÏŒÎ»Ï‰Î½ (Live)
    function calcTotals() {
        let totalNet = 0;
        let totalVat = 0;

        document.querySelectorAll('#invoiceItems tr').forEach(row => {
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const vatPct = parseFloat(row.querySelector('.vat-input').value) || 0;

            const lineNet = qty * price;
            const lineVat = lineNet * (vatPct / 100);

            row.querySelector('.row-total').innerText = (lineNet + lineVat).toFixed(2) + ' â‚¬';

            totalNet += lineNet;
            totalVat += lineVat;
        });

        document.getElementById('displayNet').innerText = totalNet.toFixed(2) + ' â‚¬';
        document.getElementById('displayVat').innerText = totalVat.toFixed(2) + ' â‚¬';
        document.getElementById('displayTotal').innerText = (totalNet + totalVat).toFixed(2) + ' â‚¬';
    }

    // 6. Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ Server (POST)
    async function saveInvoice() {
        const customerId = document.getElementById('customerSelect').value;
        if (!customerId) return alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï€ÎµÎ»Î¬Ï„Î· Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î±!');

        const paymentMethod = document.getElementById('paymentMethod').value;

        const items = [];

        document.querySelectorAll('#invoiceItems tr').forEach(row => {
            const productSelect = row.querySelector('.product-select');
            if (!productSelect.value) return;

            const vatSelect = row.querySelector('.vat-input');
            const selectedOption = vatSelect.options[vatSelect.selectedIndex];
            const vatCat = selectedOption.getAttribute('data-cat');

            // Î¤Î¯Ï„Î»Î¿Ï‚: Î•Î¯Ï„Îµ Î±Ï€ÏŒ Ï„Î¿ select text (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ custom text input Î¸Î± Î­Î¼Ï€Î±Î¹Î½Îµ ÎµÎ´Ï)
            const title = productSelect.options[productSelect.selectedIndex].text;

            items.push({
                product_id: productSelect.value,
                title: title,
                quantity: row.querySelector('.qty-input').value,
                unit_price: row.querySelector('.price-input').value,
                vat_percent: vatSelect.value,
                vat_category: vatCat
            });
        });

        if (items.length === 0) return alert('Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½/Ï…Ï€Î·ÏÎµÏƒÎ¯Î±!');

        const payload = {
            customer_id: customerId, // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î»Î¹Î±Î½Î¹ÎºÎ®, Î¸Î± ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ 'retail'
            date: document.getElementById('invoiceDate').value,
            payment_method: paymentMethod,
            items: items
        };

        const btn = document.querySelector('button[onclick="saveInvoice()"]');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "ÎˆÎºÎ´Î¿ÏƒÎ·...";

        try {
            const res = await fetch('/invoices/new', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                alert('Î£Ï†Î¬Î»Î¼Î±: ' + (data.message || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿ Î»Î¬Î¸Î¿Ï‚'));
                btn.disabled = false;
                btn.innerText = originalText;
            }
        } catch (err) {
            console.error(err);
            alert('Î£Ï†Î¬Î»Î¼Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚ Î¼Îµ Ï„Î¿Î½ server.');
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        addRow();
    });
</script>
{% endblock %}